<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shyam Residency | Internal Booking</title>
    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            /* Default: Classic Blue */
            --bg-body: #f4f7f6;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --primary: #2980b9;
            --primary-light: #ebf5fb;
            --accent: #e74c3c;
            --border: #ecf0f1;
            
            /* Status Colors */
            --status-avail: #27ae60;
            --status-partial: #f39c12;
            --status-full: #c0392b;
        }

        /* Royal Maroon Theme */
        [data-theme="maroon"] {
            --bg-body: #fcf4f4;
            --primary: #800000;
            --primary-light: #fbebeb;
            --text-main: #4a1c1c;
        }

        /* Forest Green Theme */
        [data-theme="green"] {
            --bg-body: #f4fcf6;
            --primary: #27ae60;
            --primary-light: #eafaf1;
            --text-main: #1e4d2b;
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --bg-body: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-main: #ecf0f1;
            --text-sub: #bdc3c7;
            --primary: #3498db;
            --primary-light: #34495e;
            --border: #404040;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: background 0.3s, color 0.3s; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); padding: 20px; }

        /* --- LAYOUT --- */
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; }
        
        /* --- THEME SWITCHER --- */
        select.theme-selector {
            padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text-main); cursor: pointer;
        }

        /* --- CALENDAR --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        
        .day-name { text-align: center; font-weight: bold; color: var(--text-sub); font-size: 0.9rem; padding: 10px 0; }
        
        .date-cell { 
            aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border);
            position: relative;
        }
        .date-cell:hover { transform: scale(1.05); border-color: var(--primary); }
        .date-cell.empty { border: none; cursor: default; }
        
        /* Status Indicators */
        .dot { height: 8px; width: 8px; border-radius: 50%; margin-top: 5px; }
        .status-avail .dot { background: var(--status-avail); display: none; } /* Clean look for empty */
        .status-partial { border-color: var(--status-partial); background: rgba(243, 156, 18, 0.1); }
        .status-partial .dot { background: var(--status-partial); }
        .status-full { border-color: var(--status-full); background: rgba(192, 57, 43, 0.1); }
        .status-full .dot { background: var(--status-full); }
        
        .selected { background: var(--primary); color: white; border-color: var(--primary); }
        .selected .dot { background: white; }

        /* --- BOOKING PANEL --- */
        .panel-title { font-size: 1.2rem; margin-bottom: 15px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-sub); }
        input, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); color: var(--text-main); }
        
        button.btn-save { 
            width: 100%; padding: 12px; background: var(--primary); color: white; border: none; 
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;
        }
        button.btn-save:disabled { opacity: 0.6; cursor: not-allowed; }

        .booking-list { margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .booking-item { 
            background: var(--primary-light); padding: 10px; border-radius: 6px; 
            margin-bottom: 8px; border-left: 4px solid var(--primary); font-size: 0.9rem;
        }
        .booking-time { font-weight: bold; display: block; margin-bottom: 4px; }
        
        .loader { display: none; text-align: center; margin-top: 10px; font-size: 0.9rem; color: var(--text-sub); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .calendar-grid { gap: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <header>
            <h1>Shyam Residency</h1>
            <select class="theme-selector" id="themeSelect">
                <option value="default">Classic Blue</option>
                <option value="maroon">Royal Maroon</option>
                <option value="green">Forest Green</option>
                <option value="dark">Dark Mode</option>
            </select>
        </header>

        <div class="calendar-header">
            <button id="prevMonth">&lt;</button>
            <h2 id="monthYear"></h2>
            <button id="nextMonth">&gt;</button>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            </div>
    </div>

    <div class="card" id="bookingPanel">
        <div class="panel-title">Details for <span id="selectedDateDisplay">Select a date</span></div>
        
        <div id="bookingForm" style="display:none;">
            <div class="existing-bookings">
                <label>Existing Bookings:</label>
                <div id="bookingList" class="booking-list"></div>
            </div>
            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
            
            <label>Add New Booking:</label>
            <div class="form-group">
                <label>Start Time</label>
                <input type="time" id="startTime">
            </div>
            <div class="form-group">
                <label>End Time</label>
                <input type="time" id="endTime">
            </div>
            <div class="form-group">
                <label>Note (Client Name/Event)</label>
                <textarea id="note" rows="2"></textarea>
            </div>
            <button class="btn-save" id="saveBtn">Confirm Booking</button>
            <div class="loader" id="loader">Syncing with Google Sheets...</div>
        </div>
        <div id="emptyState" style="color: var(--text-sub); text-align: center; padding: 20px;">
            Click a date on the calendar to view or add bookings.
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwC5pqyTfjGh3J5AiCbmww9ez2ilbw2EkxdIntj5P_rSXKYL3UmZ38SBQxNHx-ShhgaXw/exec"; // <--- PASTE WEB APP URL HERE

    // --- STATE ---
    let currentDate = new Date();
    let bookings = [];
    let selectedDateISO = null;

    // --- DOM ELEMENTS ---
    const grid = document.getElementById('calendarGrid');
    const monthYear = document.getElementById('monthYear');
    const themeSelect = document.getElementById('themeSelect');
    const bookingForm = document.getElementById('bookingForm');
    const emptyState = document.getElementById('emptyState');
    const bookingList = document.getElementById('bookingList');
    const saveBtn = document.getElementById('saveBtn');
    const loader = document.getElementById('loader');

    // --- INITIALIZATION ---
    async function init() {
        renderCalendar();
        await fetchBookings();
        renderCalendar(); // Re-render to show dots
    }

    // --- THEME SWITCHING ---
    themeSelect.addEventListener('change', (e) => {
        if(e.target.value === 'default') {
            document.body.removeAttribute('data-theme');
        } else {
            document.body.setAttribute('data-theme', e.target.value);
        }
    });

    // --- CALENDAR LOGIC ---
    function renderCalendar() {
        grid.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        monthYear.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Days Headers
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            const div = document.createElement('div');
            div.className = 'day-name';
            div.textContent = day;
            grid.appendChild(div);
        });

        // Empty slots
        for(let i=0; i<firstDay; i++) {
            const div = document.createElement('div');
            div.className = 'date-cell empty';
            grid.appendChild(div);
        }

        // Days
        for(let i=1; i<=daysInMonth; i++) {
            const div = document.createElement('div');
            div.className = 'date-cell';
            div.textContent = i;
            
            // Generate ISO Date
            const dateISO = `${year}-${String(month+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            
            // Check Bookings
            const dayBookings = bookings.filter(b => b.date === dateISO);
            
            // Color Logic
            if(dayBookings.length > 0) {
                // Calculate total hours booked to determine if "Full"
                let totalHours = 0;
                dayBookings.forEach(b => {
                    // Simple heuristic for demo
                    totalHours += 4; 
                });
                
                if (dayBookings.length >= 3) {
                     div.classList.add('status-full');
                } else {
                    div.classList.add('status-partial');
                }
                
                const dot = document.createElement('div');
                dot.className = 'dot';
                div.appendChild(dot);
            } else {
                div.classList.add('status-avail');
            }

            if(dateISO === selectedDateISO) div.classList.add('selected');

            div.addEventListener('click', () => selectDate(dateISO, div));
            grid.appendChild(div);
        }
    }

    // --- INTERACTION ---
    function selectDate(isoDate, element) {
        selectedDateISO = isoDate;
        document.querySelectorAll('.date-cell').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
        
        document.getElementById('selectedDateDisplay').textContent = isoDate;
        emptyState.style.display = 'none';
        bookingForm.style.display = 'block';
        
        // Populate existing bookings list
        const dayBookings = bookings.filter(b => b.date === isoDate);
        bookingList.innerHTML = '';
        if(dayBookings.length === 0) {
            bookingList.innerHTML = '<div style="color:var(--text-sub); font-style:italic;">No bookings yet.</div>';
        } else {
            dayBookings.sort((a,b) => a.start.localeCompare(b.start)).forEach(b => {
                const item = document.createElement('div');
                item.className = 'booking-item';
                item.innerHTML = `<span class="booking-time">${b.start} - ${b.end}</span> ${b.note}`;
                bookingList.appendChild(item);
            });
        }
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    // --- API HANDLING ---
    async function fetchBookings() {
        try {
            const res = await fetch(API_URL);
            bookings = await res.json();
        } catch (e) {
            console.error("Failed to fetch", e);
            alert("Could not load bookings. Check connection.");
        }
    }

    saveBtn.addEventListener('click', async () => {
        const start = document.getElementById('startTime').value;
        const end = document.getElementById('endTime').value;
        const note = document.getElementById('note').value;

        if(!start || !end || !note) return alert("Please fill all fields");
        if(start >= end) return alert("Start time must be before End time");

        // UI Feedback
        saveBtn.disabled = true;
        loader.style.display = 'block';

        const payload = {
            date: selectedDateISO,
            start: start,
            end: end,
            note: note
        };

        try {
            // Using text/plain to avoid CORS Preflight issues in GAS
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const result = await res.json();

            if(result.status === 'success') {
                alert("Booking Saved!");
                document.getElementById('note').value = ''; // Clear note
                await fetchBookings(); // Refresh data
                renderCalendar(); // Re-color calendar
                // Re-select date to refresh list
                const selectedEl = document.querySelector('.selected');
                if(selectedEl) selectDate(selectedDateISO, selectedEl);
            } else {
                alert("Error: " + result.message);
            }
        } catch (e) {
            alert("Submission failed.");
        } finally {
            saveBtn.disabled = false;
            loader.style.display = 'none';
        }
    });

    init();
</script>

</body>
</html>
