<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shyam Residency | Admin Booking</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* SAME CSS AS BEFORE - KEEPING IT CONSISTENT */
        :root { --primary: #2563eb; --primary-hover: #1d4ed8; --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text: #1e293b; --danger: #ef4444; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        
        #auth-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .auth-box { background: var(--surface); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; }
        button:hover { background: var(--primary-hover); }
        button.secondary { background: #e2e8f0; color: #475569; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .day-name { background: var(--bg); padding: 10px; text-align: center; font-weight: 600; }
        .day-cell { background: var(--surface); min-height: 100px; padding: 8px; cursor: pointer; transition: background 0.2s; }
        .day-cell:hover { background: #eff6ff; }
        .booking-chip { font-size: 0.75rem; background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px; margin-top: 2px; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        #side-panel { position: fixed; top: 0; right: -400px; width: 400px; height: 100%; background: var(--surface); box-shadow: -4px 0 20px rgba(0,0,0,0.1); padding: 20px; transition: right 0.3s ease; z-index: 500; overflow-y: auto; }
        #side-panel.open { right: 0; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; vertical-align: middle; margin-left:10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Mobile */
        @media (max-width: 768px) {
            .day-cell { min-height: 60px; font-size: 0.8rem; }
            .booking-chip { display: none; }
            .has-booking::after { content: '‚Ä¢'; color: var(--primary); font-size: 1.5rem; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); }
            #side-panel { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <h2>üîí Admin Access</h2>
            <p>Mindplus IT Solutions</p>
            <input type="password" id="password-input" placeholder="Enter Admin Password">
            <button onclick="authenticate()">Login <div id="auth-loader" class="loader"></div></button>
            <p id="auth-error" style="color:var(--danger); display:none; margin-top:10px;">Incorrect Password</p>
        </div>
    </div>

    <div class="container" id="app-container">
        <header>
            <div>
                <h1 style="margin:0; font-size:1.5rem;">Shyam Residency</h1>
                <span style="font-size:0.9rem; color:#64748b">Community Hall Booking System</span>
            </div>
            <button class="secondary" onclick="location.reload()">Logout</button>
        </header>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button class="secondary" onclick="changeMonth(-1)">‚Üê Prev</button>
            <h2 id="current-month-year" style="margin:0;"></h2>
            <button class="secondary" onclick="changeMonth(1)">Next ‚Üí</button>
        </div>

        <div id="calendar" class="calendar-grid"></div>
    </div>

    <div id="side-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px;">
            <h3 id="panel-date">Selected Date</h3>
            <button onclick="togglePanel(false)" style="background:none; color:#64748b; font-size:1.5rem; padding:0;">&times;</button>
        </div>

        <h4>Add New Booking</h4>
        <form id="booking-form" onsubmit="saveBooking(event)">
            <label>Start Time</label> <input type="time" id="start-time" required>
            <label>End Time</label> <input type="time" id="end-time" required>
            <label>Note</label> <textarea id="booking-note" rows="3" required placeholder="Details..."></textarea>
            <button type="submit" style="width:100%; margin-top:10px;">Confirm Booking <div id="save-loader" class="loader"></div></button>
        </form>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
        <h4>Existing Bookings</h4>
        <div id="existing-list"></div>
    </div>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURATION
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwC5pqyTfjGh3J5AiCbmww9ez2ilbw2EkxdIntj5P_rSXKYL3UmZ38SBQxNHx-ShhgaXw/exec"; 
        
        let currentDate = new Date();
        let bookingsCache = [];
        let selectedDateStr = "";

        // --- API Helper (The Bridge) ---
        async function apiCall(method, params = {}, payload = null) {
            // Build URL with parameters for GET
            let url = API_URL;
            if (method === 'GET') {
                const qs = new URLSearchParams(params).toString();
                url += `?${qs}`;
                const res = await fetch(url);
                return await res.json();
            } 
            
            // POST Request
            if (method === 'POST') {
                // IMPORTANT: We use 'text/plain' to avoid CORS preflight options
                const body = JSON.stringify({ action: params.action, payload: payload });
                const res = await fetch(url, {
                    method: 'POST',
                    body: body,
                    headers: { "Content-Type": "text/plain" }
                });
                return await res.json();
            }
        }

        // --- Auth ---
        async function authenticate() {
            const pass = document.getElementById('password-input').value;
            const loader = document.getElementById('auth-loader');
            const errorMsg = document.getElementById('auth-error');
            
            loader.style.display = 'inline-block';
            errorMsg.style.display = 'none';

            try {
                const data = await apiCall('POST', { action: 'auth', password: pass }, { password: pass }); // pass password in payload
                
                if (data.valid) {
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    loadCalendar();
                } else {
                    errorMsg.style.display = 'block';
                }
            } catch (e) {
                alert("Connection Error");
                console.error(e);
            } finally {
                loader.style.display = 'none';
            }
        }

        // --- Calendar ---
        async function loadCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('current-month-year').innerText = 
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Show loading state?
            const res = await apiCall('GET', { action: 'getBookings', year: year, month: month });
            if (res.status === 'success') {
                bookingsCache = res.data;
                renderGrid(year, month);
            }
        }

        function renderGrid(year, month) {
            const grid = document.getElementById('calendar');
            grid.innerHTML = '';
            
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => 
                grid.innerHTML += `<div class="day-name">${d}</div>`
            );

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="day-cell" style="background:var(--bg); cursor:default;"></div>`;

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayBookings = bookingsCache.filter(b => b.date === dateStr);
                const hasBooking = dayBookings.length > 0;
                
                const chips = dayBookings.map(b => `<div class="booking-chip">${b.start} ${b.note}</div>`).join('');
                
                const cell = document.createElement('div');
                cell.className = `day-cell ${hasBooking ? 'has-booking' : ''}`;
                cell.innerHTML = `<div>${i}</div>${chips}`;
                cell.onclick = () => openPanel(dateStr, dayBookings);
                grid.appendChild(cell);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            loadCalendar();
        }

        // --- Panel & Saving ---
        function openPanel(dateStr, bookings) {
            selectedDateStr = dateStr;
            document.getElementById('panel-date').innerText = new Date(dateStr).toDateString();
            document.getElementById('side-panel').classList.add('open');
            document.getElementById('booking-form').reset();
            
            const list = document.getElementById('existing-list');
            list.innerHTML = bookings.length ? '' : '<p style="color:#94a3b8">No bookings.</p>';
            
            bookings.sort((a,b) => a.start.localeCompare(b.start)).forEach(b => {
                list.innerHTML += `<div style="background:#f1f5f9; padding:10px; border-radius:6px; margin-bottom:8px; border-left:3px solid var(--primary);">
                    <div style="font-weight:600">${b.start} - ${b.end}</div>
                    <div style="font-size:0.85rem; color:#475569">${b.note}</div>
                </div>`;
            });
        }

        function togglePanel(show) {
            document.getElementById('side-panel').classList.toggle('open', show);
        }

        async function saveBooking(e) {
            e.preventDefault();
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            
            if(start >= end) return alert('Start time must be earlier than end time.');

            document.getElementById('save-loader').style.display = 'inline-block';
            
            const payload = {
                date: selectedDateStr,
                start: start,
                end: end,
                note: document.getElementById('booking-note').value
            };

            try {
                const res = await apiCall('POST', { action: 'addBooking' }, payload);
                if (res.status === 'success') {
                    alert('Saved!');
                    togglePanel(false);
                    loadCalendar();
                } else {
                    alert('Error: ' + res.error);
                }
            } catch (err) {
                alert('Request failed');
            } finally {
                document.getElementById('save-loader').style.display = 'none';
            }
        }
    </script>
</body>
</html>
